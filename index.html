<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ofertas Rápidas Yautepec</title>
    
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #f8fafc;
            --accent: #2563eb;
            --danger: #ef4444;
            --success: #10b981;
            --dark: #1e293b;
        }

        body { 
            background-color: var(--bg); 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            padding-bottom: 90px;
        }

        .header {
            background: var(--dark);
            color: white;
            padding: 1.2rem 1rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .card-custom {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 1.25rem;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            border-top: 1px solid #e2e8f0;
            z-index: 1000;
            padding: 8px 0;
        }

        .nav-btn {
            flex: 1;
            border: none;
            background: none;
            color: #94a3b8;
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .nav-btn i { font-size: 1.5rem; margin-bottom: 4px; }
        .nav-btn.active { color: var(--accent); font-weight: 700; }

        /* Autocomplete */
        .search-container { position: relative; }
        .sug-box {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            max-height: 180px;
            overflow-y: auto;
            z-index: 1100;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            margin-top: 5px;
        }
        .sug-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .sug-item:hover { background: #f8fafc; }

        #loader {
            position: fixed; inset: 0;
            background: white;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999;
        }

        #toast-container {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%);
            z-index: 10001; width: 90%; max-width: 400px;
        }

        .custom-toast {
            background: white; padding: 14px 20px; border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            margin-bottom: 10px; display: flex; align-items: center;
            animation: slideIn 0.3s ease-out; border-left: 6px solid var(--accent);
        }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .btn-save {
            background: var(--accent); color: white; border-radius: 12px;
            padding: 14px; font-weight: 700; width: 100%; border: none;
            transition: 0.2s; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }
        .btn-save:disabled { opacity: 0.6; pointer-events: none; }

        .delete-btn { color: #cbd5e0; cursor: pointer; border: none; background: none; padding: 8px; }
        .delete-btn:hover { color: var(--danger); }
        
        .badge-cost { background: #f1f5f9; color: #64748b; font-size: 0.65rem; padding: 3px 8px; border-radius: 6px; display: inline-block; }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-grow text-primary" role="status"></div>
        <p class="mt-3 fw-bold text-dark">Sincronizando con la nube...</p>
        <button id="btn-bypass" class="btn btn-sm btn-outline-secondary mt-3 d-none" onclick="document.getElementById('loader').style.display='none'">
            Omitir espera y entrar
        </button>
    </div>

    <div id="toast-container"></div>

    <div class="header">
        <h5 class="m-0 fw-bold">Ofertas Rápidas Yautepec</h5>
        <div id="status-label" class="small opacity-75">
            <span class="status-dot bg-warning"></span> Conectando...
        </div>
    </div>

    <main class="container py-4">
        
        <!-- SECCIÓN REGISTRO -->
        <div id="sec-venta" class="app-section">
            <div class="card-custom">
                <div class="d-flex align-items-center mb-4">
                    <div class="bg-primary bg-opacity-10 p-2 rounded-3 me-3">
                        <i class="fas fa-cart-plus text-primary"></i>
                    </div>
                    <h6 class="fw-bold mb-0">NUEVA VENTA</h6>
                </div>
                
                <div class="mb-3 search-container">
                    <label class="small fw-bold text-muted mb-1">Cliente</label>
                    <input type="text" id="in-cliente" class="form-control" placeholder="¿A quién le vendes?" autocomplete="off">
                    <div id="sug-cliente" class="sug-box d-none"></div>
                </div>

                <div class="mb-3 search-container">
                    <label class="small fw-bold text-muted mb-1">Tienda</label>
                    <input type="text" id="in-tienda" class="form-control" placeholder="Tienda de origen" autocomplete="off">
                    <div id="sug-tienda" class="sug-box d-none"></div>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-8 search-container">
                        <label class="small fw-bold text-muted mb-1">Producto</label>
                        <input type="text" id="in-producto" class="form-control" placeholder="Nombre del producto">
                        <div id="sug-producto" class="sug-box d-none"></div>
                    </div>
                    <div class="col-4">
                        <label class="small fw-bold text-muted mb-1">Cant.</label>
                        <input type="number" id="in-cant" class="form-control text-center" value="1">
                    </div>
                </div>

                <div class="row g-2 mb-4">
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Costo Unit.</label>
                        <input type="number" id="in-costo" class="form-control" placeholder="0.00">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Precio Venta</label>
                        <input type="number" id="in-precio" class="form-control" placeholder="0.00">
                    </div>
                </div>

                <button id="btn-save" class="btn-save shadow">
                    <i class="fas fa-check-circle me-2"></i>GUARDAR REGISTRO
                </button>
            </div>
        </div>

        <!-- SECCIÓN HISTORIAL -->
        <div id="sec-historial" class="app-section d-none">
            <div class="d-flex justify-content-between align-items-center mb-3 px-1">
                <h6 class="fw-bold text-dark m-0">HISTORIAL RECIENTE</h6>
                <span class="badge bg-white text-dark border fw-normal" id="date-label"></span>
            </div>
            
            <div class="card-custom p-0 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3">Detalle</th>
                                <th class="text-end">Monto</th>
                                <th class="text-center"></th>
                            </tr>
                        </thead>
                        <tbody id="lista-ventas">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-state" class="text-center py-5 d-none">
                    <i class="fas fa-receipt fa-3x text-light mb-3"></i>
                    <p class="text-muted small">Sin registros todavía</p>
                </div>
            </div>
        </div>

    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="showTab('venta', this)">
            <i class="fas fa-edit"></i>Registro
        </button>
        <button class="nav-btn" onclick="showTab('historial', this)">
            <i class="fas fa-table-list"></i>Historial
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACIÓN DE RESPALDO (Tus credenciales reales)
        const backupConfig = {
            apiKey: "AIzaSyCR5V_yg6aLumW_D8oFPEblHZ5ox2gTs98",
            authDomain: "ofertas-rapidas-yautepec.firebaseapp.com",
            projectId: "ofertas-rapidas-yautepec",
            storageBucket: "ofertas-rapidas-yautepec.firebasestorage.app",
            messagingSenderId: "81339635207",
            appId: "1:81339635207:web:26d180f92224d9a036fca2"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : backupConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ofertas-yaute-v1';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let catalogs = { clients: [], products: [], stores: [], sales: [] };
        let userAuthenticated = null;

        // Mostrar botón de bypass tras 5 segundos
        setTimeout(() => {
            const btn = document.getElementById('btn-bypass');
            if (btn && !userAuthenticated) btn.classList.remove('d-none');
        }, 5000);

        // NOTIFICACIONES
        window.notify = (msg, type = 'accent') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.style.borderLeftColor = `var(--${type})`;
            toast.innerHTML = `<i class="fas fa-info-circle me-3 text-${type}"></i><span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        };

        // INICIALIZACIÓN DE AUTH
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.warn("Falla en Auth automático, reintentando...");
                // Bypass si falla el primer intento
                document.getElementById('status-label').innerText = "Conexión limitada";
            }
        };

        onAuthStateChanged(auth, (user) => {
            userAuthenticated = user;
            if (user) {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('status-label').innerHTML = '<span class="status-dot bg-success"></span> Conectado';
                startSync();
            }
        });

        // SINCRONIZACIÓN
        const startSync = () => {
            const syncCol = (name) => {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', name);
                onSnapshot(colRef, (snap) => {
                    catalogs[name] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderUI();
                }, (err) => {
                    console.error("Error cargando " + name, err);
                });
            };
            ['clients', 'products', 'stores', 'sales'].forEach(syncCol);
        };

        // NAVEGACIÓN
        window.showTab = (id, btn) => {
            document.querySelectorAll('.app-section').forEach(s => s.classList.add('d-none'));
            document.getElementById(`sec-${id}`).classList.remove('d-none');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (id === 'historial') document.getElementById('date-label').innerText = new Date().toLocaleDateString();
        };

        // GUARDADO DE VENTA
        document.getElementById('btn-save').onclick = async () => {
            const btn = document.getElementById('btn-save');
            const form = {
                cliente: document.getElementById('in-cliente').value.trim(),
                tienda: document.getElementById('in-tienda').value.trim(),
                producto: document.getElementById('in-producto').value.trim(),
                cant: parseInt(document.getElementById('in-cant').value) || 1,
                costo: parseFloat(document.getElementById('in-costo').value) || 0,
                precio: parseFloat(document.getElementById('in-precio').value) || 0
            };

            if (!form.cliente || !form.producto || form.precio <= 0) return window.notify("Datos incompletos", "danger");

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Guardando...';

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), {
                    ...form,
                    total: form.cant * form.precio,
                    fecha: serverTimestamp(),
                    fechaStr: new Date().toLocaleDateString()
                });

                // Catálogos automáticos
                const addCat = (cat, val) => {
                    if (!catalogs[cat].some(i => i.nombre.toLowerCase() === val.toLowerCase())) {
                        addDoc(collection(db, 'artifacts', appId, 'public', 'data', cat), { nombre: val });
                    }
                };
                addCat('clients', form.cliente);
                addCat('stores', form.tienda);
                if (!catalogs.products.some(p => p.nombre.toLowerCase() === form.producto.toLowerCase())) {
                    addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), { 
                        nombre: form.producto, pCosto: form.costo, pVenta: form.precio 
                    });
                }

                document.getElementById('in-producto').value = "";
                document.getElementById('in-costo').value = "";
                document.getElementById('in-precio').value = "";
                document.getElementById('in-cant').value = "1";
                window.notify("✅ Venta registrada", "success");

            } catch (e) {
                window.notify("Error al guardar en la nube", "danger");
            } finally {
                btn.disabled = false;
                btn.innerText = "GUARDAR REGISTRO";
            }
        };

        // BORRADO
        window.deleteSale = async (id) => {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sales', id));
                window.notify("Registro eliminado", "accent");
            } catch (e) { window.notify("Error al borrar", "danger"); }
        };

        // RENDERIZADO
        const renderUI = () => {
            const list = document.getElementById('lista-ventas');
            const empty = document.getElementById('empty-state');
            
            const sorted = [...catalogs.sales].sort((a,b) => {
                const tA = a.fecha?.seconds || Date.now();
                const tB = b.fecha?.seconds || Date.now();
                return tB - tA;
            });

            if (sorted.length === 0) {
                list.innerHTML = "";
                empty.classList.remove('d-none');
                return;
            }

            empty.classList.add('d-none');
            list.innerHTML = sorted.map(s => {
                const dateObj = s.fecha?.toDate ? s.fecha.toDate() : new Date();
                const time = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const date = dateObj.toLocaleDateString([], { day: '2-digit', month: '2-digit' });
                return `
                <tr>
                    <td class="ps-3">
                        <div class="fw-bold" style="font-size: 0.9rem;">${s.producto}</div>
                        <div class="text-muted small">${s.cliente} • ${s.cant} pza</div>
                        <div class="text-muted" style="font-size: 0.65rem;">${date} | ${time}</div>
                    </td>
                    <td class="text-end">
                        <div class="badge-cost mb-1">Costo: $${(s.costo || 0).toFixed(2)}</div>
                        <div class="fw-bold text-primary">$${(s.total || 0).toFixed(2)}</div>
                    </td>
                    <td class="text-center">
                        <button class="delete-btn" onclick="deleteSale('${s.id}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        };

        // AUTO-COMPLETADO
        const setupAuto = (inId, sugId, listKey) => {
            const input = document.getElementById(inId);
            const box = document.getElementById(sugId);
            input.oninput = () => {
                const val = input.value.toLowerCase().trim();
                if (!val) { box.classList.add('d-none'); return; }
                const matches = catalogs[listKey].filter(i => (i.nombre || '').toLowerCase().includes(val)).slice(0, 5);
                box.innerHTML = matches.map(m => `<div class="sug-item" data-name="${m.nombre}">${m.nombre}</div>`).join('');
                box.classList.toggle('d-none', matches.length === 0);
            };
            box.onclick = (e) => {
                const name = e.target.getAttribute('data-name') || e.target.parentElement.getAttribute('data-name');
                if (name) {
                    input.value = name; box.classList.add('d-none');
                    if (listKey === 'products') {
                        const p = catalogs.products.find(x => x.nombre === name);
                        if (p) {
                            document.getElementById('in-costo').value = p.pCosto || 0;
                            document.getElementById('in-precio').value = p.pVenta || 0;
                        }
                    }
                }
            };
        };

        setupAuto('in-cliente', 'sug-cliente', 'clients');
        setupAuto('in-tienda', 'sug-tienda', 'stores');
        setupAuto('in-producto', 'sug-producto', 'products');

        initAuth();
    </script>
</body>
</html>