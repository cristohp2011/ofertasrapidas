<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ofertas Rápidas Yautepec Pro</title>
    
    <!-- Librerías de confianza -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #1e293b;
            --accent: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
        }

        body { 
            background-color: var(--bg); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            padding-bottom: 90px;
            user-select: none;
        }

        header {
            background: var(--primary);
            color: white; padding: 1rem; text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 1000;
        }

        .header-logo {
            height: 50px;
            margin-bottom: 8px;
            object-fit: contain;
        }

        .card-custom {
            background: white; border-radius: 16px; padding: 20px;
            margin-bottom: 15px; border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        /* Notificación Flotante */
        #toast-alert {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            background: var(--success);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: bold;
            display: none;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2);
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from { transform: translate(-50%, -100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        /* Modales de Edición */
        #edit-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            z-index: 3000; display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            background: white; display: flex; 
            justify-content: space-around;
            padding: 10px 0; border-top: 1px solid #e2e8f0; z-index: 2000;
        }

        .tab-btn {
            background: none; border: none; color: #94a3b8;
            font-size: 0.7rem; display: flex; flex-direction: column;
            align-items: center; flex: 1;
        }
        .tab-btn i { font-size: 1.5rem; margin-bottom: 4px; }
        .tab-btn.active { color: var(--accent); font-weight: bold; }

        /* Sub-pestañas Catálogos */
        .sub-nav {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px;
            scrollbar-width: none;
        }
        .sub-nav::-webkit-scrollbar { display: none; }
        .sub-btn { 
            background: white; border: 1px solid #e2e8f0; border-radius: 20px; 
            padding: 6px 15px; font-size: 0.75rem; white-space: nowrap; color: #64748b;
        }
        .sub-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Autocomplete */
        .search-wrapper { position: relative; }
        .sug-box {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border-radius: 12px;
            max-height: 200px; overflow-y: auto; z-index: 1500;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-top: 5px;
        }
        .sug-item { padding: 14px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }

        #loading-screen {
            position: fixed; inset: 0; background: white;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; z-index: 9999;
        }

        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .entregado-row { background-color: #f0fdf4 !important; border-left: 5px solid var(--success) !important; }
        
        /* Ticket */
        #ticket-render {
            position: fixed; left: -5000px; width: 320px; background: white;
            padding: 25px; color: black; font-family: 'Courier New', monospace;
        }
        .ticket-logo { width: 100px; height: auto; display: block; margin: 0 auto 10px; }
        
        .action-icon { padding: 8px; cursor: pointer; opacity: 0.6; transition: 0.2s; }
        .action-icon:active { opacity: 1; transform: scale(1.1); }
        .text-price { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 fw-bold">Gestión Yaute Pro...</p>
    </div>

    <!-- Mensaje de Éxito -->
    <div id="toast-alert"><i class="fas fa-check-circle me-2"></i> Operación exitosa</div>

    <!-- Modal de Edición -->
    <div id="edit-overlay">
        <div class="card-custom m-3 w-100" style="max-width: 400px;">
            <h5 id="edit-title" class="fw-bold mb-4">Editar Registro</h5>
            <div id="edit-form-body">
                <!-- Se llena dinámicamente -->
            </div>
            <div class="d-flex gap-2 mt-4">
                <button class="btn btn-light flex-1 w-100 py-2" onclick="closeEdit()">Cancelar</button>
                <button id="btn-save-edit" class="btn btn-primary flex-1 w-100 py-2">Guardar</button>
            </div>
        </div>
    </div>

    <header>
        <img src="logo.png" alt="Logo" class="header-logo" onerror="this.style.display='none'">
        <h5 class="m-0 fw-bold">Ofertas Rápidas Yautepec</h5>
        <div class="opacity-75 mt-1">
            <small id="status-label"><span class="status-dot bg-warning"></span> Conectando...</small>
        </div>
    </header>

    <div class="container py-3">
        
        <!-- PESTAÑA: VENTA -->
        <div id="tab-venta" class="tab-content active">
            <div class="card-custom">
                <div class="mb-3 search-wrapper">
                    <label class="small fw-bold text-muted mb-1">TIENDA (SE MANTIENE)</label>
                    <input type="text" id="in-tienda" class="form-control" placeholder="Nombre de tienda..." autocomplete="off">
                    <div id="sug-tienda" class="sug-box d-none"></div>
                </div>

                <div class="mb-3 search-wrapper">
                    <label class="small fw-bold text-muted mb-1">CLIENTE</label>
                    <input type="text" id="in-cliente" class="form-control" placeholder="Nombre del cliente..." autocomplete="off">
                    <div id="sug-cliente" class="sug-box d-none"></div>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-8 search-wrapper">
                        <label class="small fw-bold text-muted mb-1">PRODUCTO</label>
                        <input type="text" id="in-producto" class="form-control" placeholder="¿Qué vendiste?">
                        <div id="sug-producto" class="sug-box d-none"></div>
                    </div>
                    <div class="col-4">
                        <label class="small fw-bold text-muted">CANT.</label>
                        <input type="number" id="in-cantidad" class="form-control text-center" value="1">
                    </div>
                </div>

                <div class="row g-2 mb-4">
                    <div class="col-6">
                        <label class="small fw-bold text-muted">COSTO U.</label>
                        <input type="number" id="in-costo" class="form-control" placeholder="0.00">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted">VENTA U.</label>
                        <input type="number" id="in-precio" class="form-control" placeholder="0.00">
                    </div>
                </div>

                <button id="btn-save" class="btn btn-primary w-100 py-3 fw-bold shadow">
                    <i class="fas fa-save me-2"></i>GUARDAR VENTA
                </button>
            </div>
        </div>

        <!-- PESTAÑA: ENTREGAS -->
        <div id="tab-entregas" class="tab-content">
            <h6 class="fw-bold text-muted mb-3 px-1">CONTROL DE REPARTO (HOY)</h6>
            <div id="lista-entregas"></div>
        </div>

        <!-- PESTAÑA: CATÁLOGOS -->
        <div id="tab-catalogos" class="tab-content">
            <div class="sub-nav">
                <button class="sub-btn active" onclick="switchSubTab('sales', this)">Ventas</button>
                <button class="sub-btn" onclick="switchSubTab('products', this)">Productos</button>
                <button class="sub-btn" onclick="switchSubTab('clients', this)">Clientes</button>
                <button class="sub-btn" onclick="switchSubTab('stores', this)">Tiendas</button>
            </div>
            
            <div id="lista-catalogos">
                <!-- Se llena dinámicamente -->
            </div>
        </div>

    </div>

    <!-- Ticket Invisible -->
    <div id="ticket-render">
        <img src="logo.png" alt="Logo" class="ticket-logo" onerror="this.style.display='none'">
        <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: bold;">OFERTAS RÁPIDAS YAUTEPEC</h3>
            <small id="t-fecha"></small>
        </div>
        <p style="font-size: 0.9rem; margin-bottom: 5px;"><b>CLIENTE:</b> <span id="t-cliente"></span></p>
        <p style="font-size: 0.9rem; display: none;"><b>TIENDA:</b> <span id="t-tienda"></span></p>
        <div id="t-items" style="border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; margin-top: 10px;"></div>
        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1rem;">
            <span>TOTAL:</span>
            <span id="t-total"></span>
        </div>
        <p style="text-align: center; margin-top: 20px; font-size: 0.7rem; letter-spacing: 1px;">¡GRACIAS POR SU PREFERENCIA!</p>
    </div>

    <nav class="bottom-nav">
        <button class="tab-btn active" onclick="showTab('venta', this)"><i class="fas fa-plus-circle"></i>Venta</button>
        <button class="tab-btn" onclick="showTab('entregas', this)"><i class="fas fa-truck"></i>Hoy</button>
        <button class="tab-btn" onclick="showTab('catalogos', this)"><i class="fas fa-boxes-stacked"></i>Catálogos</button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeFirestore, collection, doc, addDoc, deleteDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCR5V_yg6aLumW_D8oFPEblHZ5ox2gTs98",
            authDomain: "ofertas-rapidas-yautepec.firebaseapp.com",
            projectId: "ofertas-rapidas-yautepec",
            storageBucket: "ofertas-rapidas-yautepec.firebasestorage.app",
            messagingSenderId: "81339635207",
            appId: "1:81339635207:web:26d180f92224d9a036fca2"
        };

        const appId = "yaute-v1-shared";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });

        let state = { clients: [], products: [], stores: [], sales: [] };
        let activeSubTab = 'sales';

        signInAnonymously(auth);
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('status-label').innerHTML = '<span class="status-dot bg-success"></span> Online';
                startSync();
            }
        });

        const startSync = () => {
            const syncCol = (name) => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', name), (s) => {
                    state[name] = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderAll();
                });
            };
            ['clients', 'products', 'stores', 'sales'].forEach(syncCol);
        };

        window.showTab = (id, btn) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };

        window.switchSubTab = (id, btn) => {
            activeSubTab = id;
            document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCatalogList();
        };

        const renderAll = () => {
            renderEntregas();
            renderCatalogList();
        };

        const renderEntregas = () => {
            const hoy = new Date().toLocaleDateString();
            const vHoy = state.sales.filter(s => s.fechaStr === hoy);
            const list = document.getElementById('lista-entregas');
            
            if (vHoy.length === 0) { list.innerHTML = '<p class="text-center py-5 text-muted opacity-50">Sin ventas registradas hoy</p>'; return; }

            const grouped = vHoy.reduce((acc, v) => {
                const c = v.cliente || "Sin Nombre";
                if(!acc[c]) acc[c] = {total: 0, items: []};
                acc[c].total += (v.total || 0);
                acc[c].items.push(v);
                return acc;
            }, {});

            list.innerHTML = Object.keys(grouped).map(cli => {
                const items = grouped[cli].items;
                const totalEnt = items.every(i => i.entregado);
                return `
                <div class="card-custom mb-3 ${totalEnt ? 'entregado-row opacity-75' : ''}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold fs-6">${cli}</span>
                        <button class="btn btn-sm btn-dark px-3 rounded-pill" onclick="genTicket('${cli}')"><i class="fas fa-file-invoice"></i> Ticket</button>
                    </div>
                    <div class="small">
                        ${items.map(i => `
                            <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-1">
                                <span class="${i.entregado ? 'text-decoration-line-through text-muted' : ''}">${i.cantidad}x ${i.producto}</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" ${i.entregado ? 'checked' : ''} onchange="toggleEnt('${i.id}', ${i.entregado})">
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-end fw-bold text-success pt-2">Total: $${grouped[cli].total.toFixed(2)}</div>
                </div>`;
            }).join('');
        };

        window.toggleEnt = async (id, val) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sales', id), { entregado: !val });
        };

        const renderCatalogList = () => {
            const list = document.getElementById('lista-catalogos');
            const data = state[activeSubTab] || [];

            if (activeSubTab === 'sales') {
                const sorted = [...data].sort((a,b) => (b.fecha?.seconds || 0) - (a.fecha?.seconds || 0));
                list.innerHTML = sorted.map(s => `
                    <div class="card-custom d-flex justify-content-between align-items-center py-3 mb-2">
                        <div>
                            <div class="fw-bold">${s.producto}</div>
                            <div class="text-muted small">${s.cliente} • ${s.tienda || ''}</div>
                        </div>
                        <div class="text-end d-flex align-items-center gap-2">
                            <span class="text-price me-2">$${(s.total || 0).toFixed(2)}</span>
                            <i class="fas fa-pen action-icon text-primary" onclick="openEdit('sales', '${s.id}')"></i>
                            <i class="fas fa-trash action-icon text-danger" onclick="del('sales', '${s.id}')"></i>
                        </div>
                    </div>
                `).join('') || '<p class="text-center py-5 text-muted">Historial vacío</p>';
            } else {
                list.innerHTML = data.map(item => `
                    <div class="card-custom d-flex justify-content-between align-items-center py-3 mb-2">
                        <div>
                            <div class="fw-bold">${item.nombre}</div>
                            ${activeSubTab === 'products' ? `<small class="text-muted">C: $${item.pCosto || 0} / V: $${item.pVenta || 0}</small>` : ''}
                        </div>
                        <div class="d-flex gap-2">
                            <i class="fas fa-pen action-icon text-primary" onclick="openEdit('${activeSubTab}', '${item.id}')"></i>
                            <i class="fas fa-trash action-icon text-danger" onclick="del('${activeSubTab}', '${item.id}')"></i>
                        </div>
                    </div>
                `).join('') || '<p class="text-center py-5 text-muted">Catálogo vacío</p>';
            }
        };

        window.del = async (col, id) => {
            if (confirm("¿Eliminar de forma permanente?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
        };

        // LÓGICA DE EDICIÓN
        let currentEdit = null;
        window.openEdit = (col, id) => {
            const item = state[col].find(x => x.id === id);
            if(!item) return;
            currentEdit = { col, id };
            
            const form = document.getElementById('edit-form-body');
            document.getElementById('edit-title').innerText = `Editar ${col === 'sales' ? 'Venta' : col === 'products' ? 'Producto' : 'Nombre'}`;
            
            if(col === 'sales') {
                form.innerHTML = `
                    <label class="small fw-bold">Producto</label><input id="edit-val-1" class="form-control mb-2" value="${item.producto}">
                    <label class="small fw-bold">Cliente</label><input id="edit-val-2" class="form-control mb-2" value="${item.cliente}">
                    <label class="small fw-bold">Cantidad</label><input id="edit-val-3" type="number" class="form-control mb-2" value="${item.cantidad}">
                    <label class="small fw-bold">Precio Unitario</label><input id="edit-val-4" type="number" class="form-control" value="${item.precio}">
                `;
            } else if(col === 'products') {
                form.innerHTML = `
                    <label class="small fw-bold">Nombre</label><input id="edit-val-1" class="form-control mb-2" value="${item.nombre}">
                    <label class="small fw-bold">Costo</label><input id="edit-val-2" type="number" class="form-control mb-2" value="${item.pCosto || 0}">
                    <label class="small fw-bold">Precio Venta</label><input id="edit-val-3" type="number" class="form-control" value="${item.pVenta || 0}">
                `;
            } else {
                form.innerHTML = `<label class="small fw-bold">Nombre</label><input id="edit-val-1" class="form-control" value="${item.nombre}">`;
            }
            
            document.getElementById('edit-overlay').style.display = 'flex';
        };

        window.closeEdit = () => {
            document.getElementById('edit-overlay').style.display = 'none';
        };

        document.getElementById('btn-save-edit').onclick = async () => {
            const { col, id } = currentEdit;
            const updates = {};
            
            if(col === 'sales') {
                const prod = document.getElementById('edit-val-1').value;
                const cant = parseInt(document.getElementById('edit-val-3').value);
                const prec = parseFloat(document.getElementById('edit-val-4').value);
                Object.assign(updates, {
                    producto: prod,
                    cliente: document.getElementById('edit-val-2').value,
                    cantidad: cant,
                    precio: prec,
                    total: cant * prec
                });
            } else if(col === 'products') {
                Object.assign(updates, {
                    nombre: document.getElementById('edit-val-1').value,
                    pCosto: parseFloat(document.getElementById('edit-val-2').value),
                    pVenta: parseFloat(document.getElementById('edit-val-3').value)
                });
            } else {
                updates.nombre = document.getElementById('edit-val-1').value;
            }
            
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id), updates);
                showToast("Cambios guardados");
                closeEdit();
            } catch(e) { alert("Error al actualizar"); }
        };

        document.getElementById('btn-save').onclick = async () => {
            const btn = document.getElementById('btn-save');
            const data = {
                tienda: document.getElementById('in-tienda').value.trim(),
                cliente: document.getElementById('in-cliente').value.trim(),
                producto: document.getElementById('in-producto').value.trim(),
                cantidad: parseInt(document.getElementById('in-cantidad').value) || 1,
                costo: parseFloat(document.getElementById('in-costo').value) || 0,
                precio: parseFloat(document.getElementById('in-precio').value) || 0
            };

            if (!data.cliente || !data.producto || data.precio <= 0) return alert("Completa los datos");

            btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), {
                    ...data, total: data.cantidad * data.precio, fecha: serverTimestamp(),
                    fechaStr: new Date().toLocaleDateString(), entregado: false
                });

                const check = (col, val) => {
                    if(!state[col].some(i => (i.nombre || "").toLowerCase() === val.toLowerCase())) {
                        addDoc(collection(db, 'artifacts', appId, 'public', 'data', col), { nombre: val });
                    }
                };
                check('clients', data.cliente);
                check('stores', data.tienda);
                
                if(!state.products.some(p => (p.nombre || "").toLowerCase() === data.producto.toLowerCase())) {
                    addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
                        nombre: data.producto, pCosto: data.costo, pVenta: data.precio
                    });
                }

                document.getElementById('in-cliente').value = "";
                document.getElementById('in-producto').value = "";
                document.getElementById('in-costo').value = "";
                document.getElementById('in-precio').value = "";
                document.getElementById('in-cantidad').value = "1";
                
                showToast("Registro guardado");

            } catch(e) { console.error(e); alert("Error de red"); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save me-2"></i>GUARDAR VENTA'; }
        };

        const showToast = (msg) => {
            const toast = document.getElementById('toast-alert');
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        };

        window.genTicket = async (cli) => {
            const hoy = new Date().toLocaleDateString();
            const items = state.sales.filter(s => s.cliente === cli && s.fechaStr === hoy);
            document.getElementById('t-fecha').innerText = new Date().toLocaleString();
            document.getElementById('t-cliente').innerText = cli;
            let total = 0;
            document.getElementById('t-items').innerHTML = items.map(i => {
                total += i.total;
                return `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${i.cantidad}x ${i.producto}</span><span>$${i.total.toFixed(2)}</span></div>`;
            }).join('');
            document.getElementById('t-total').innerText = `$${total.toFixed(2)}`;

            try {
                const canvas = await html2canvas(document.getElementById('ticket-render'), { scale: 2 });
                const link = document.createElement('a');
                link.download = `Ticket_${cli}.png`;
                link.href = canvas.toDataURL("image/png"); link.click();
            } catch(e) { alert("Error al generar el ticket"); }
        };

        const auto = (id, boxId, key) => {
            const inp = document.getElementById(id);
            const box = document.getElementById(boxId);
            inp.oninput = () => {
                const val = inp.value.toLowerCase().trim();
                if(!val) { box.classList.add('d-none'); return; }
                const m = state[key].filter(x => (x.nombre || '').toLowerCase().includes(val)).slice(0, 5);
                box.innerHTML = m.map(x => `<div class="sug-item" data-v="${x.nombre}">${x.nombre}</div>`).join('');
                box.classList.toggle('d-none', m.length === 0);
            };
            box.onclick = (e) => {
                const v = e.target.dataset.v;
                if(v) {
                    inp.value = v; box.classList.add('d-none');
                    if(key === 'products') {
                        const p = state.products.find(x => x.nombre === v);
                        if(p) {
                            document.getElementById('in-costo').value = p.pCosto || 0;
                            document.getElementById('in-precio').value = p.pVenta || 0;
                        }
                    }
                }
            };
        };

        auto('in-tienda', 'sug-tienda', 'stores');
        auto('in-cliente', 'sug-cliente', 'clients');
        auto('in-producto', 'sug-producto', 'products');

    </script>
</body>
</html>
