<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yaute R√°pidas Pro v10.64</title>
    
    <!-- Librer√≠as de confianza -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #0f172a;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --whatsapp: #25d366;
            --bg: #f8fafc;
            --card-radius: 14px;
        }

        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--bg); }
        body { display: flex; flex-direction: column; font-family: 'Inter', sans-serif; color: #1e293b; }
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 95px; }

        /* --- SPLASH SCREEN --- */
        #splash-screen { position: fixed; inset: 0; background: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .splash-logo { width: 120px; height: auto; margin-bottom: 20px; }
        .splash-loader { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- UI --- */
        header { background: var(--primary); color: white; padding: 0.7rem 1rem; position: sticky; top: 0; z-index: 1000; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; text-align: center; }
        .card-custom { background: white; border-radius: var(--card-radius); padding: 15px; margin-bottom: 12px; border-left: 5px solid transparent; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        
        #toast-alert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 12000; padding: 12px 24px; border-radius: 50px; font-weight: 700; display: none; color: white; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-control, .form-select { padding: 0.6rem 0.8rem; font-size: 0.9rem; border-radius: 10px; border: 1.5px solid #e2e8f0; }
        label.text-uppercase { font-size: 0.6rem; margin-bottom: 3px; font-weight: 800; color: #64748b; display: block; }

        /* BOTONES IA */
        .btn-inline-cam { background: #eff6ff; color: var(--accent); border: 1.5px solid #dbeafe; border-radius: 10px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
        .btn-publish-wa { background: #dcfce7; color: #166534; border: 1.5px solid #bbf7d0; border-radius: 12px; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 800; font-size: 0.85rem; width: 100%; transition: all 0.2s; }
        .btn-publish-wa:active { transform: scale(0.98); background: #bbf7d0; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #ffffff; display: flex; justify-content: space-around; padding: 10px 0 20px; border-top: 1px solid #e2e8f0; z-index: 2000; }
        .tab-btn { background: none; border: none; color: #94a3b8; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; flex: 1; }
        .tab-btn i { font-size: 1.4rem; margin-bottom: 4px; }
        .tab-btn.active { color: var(--accent); font-weight: 800; }

        .sub-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .sub-btn { background: white; border: 1px solid #e2e8f0; border-radius: 15px; padding: 6px 14px; font-size: 0.65rem; white-space: nowrap; font-weight: 600; color: #64748b; }
        .sub-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- MODAL --- */
        #custom-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 11000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-card { background: white; border-radius: 20px; width: 100%; max-width: 380px; padding: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }

        /* --- C√ÅMARA --- */
        #cam-container { position: fixed; inset: 0; background: #000; z-index: 10500; display: none; }
        #cam-preview { width: 100%; height: 100%; object-fit: cover; }
        .cam-controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; }
        .btn-capture { width: 70px; height: 70px; background: white; border: 6px solid rgba(255,255,255,0.3); border-radius: 50%; }

        /* --- TICKET RENDERER --- */
        #ticket-render { position: absolute; top: -10000px; left: 0; width: 380px; background: white; padding: 30px; color: black; font-family: 'Courier New', Courier, monospace; }
        .ticket-header-img { width: 160px; height: auto; display: block; margin: 0 auto 10px; }

        /* Sugerencias */
        .sug-box { position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; }
        .sug-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
        .sug-item:hover { background: #f0f0f0; }

        /* Checkbox group */
        .check-group { display: flex; gap: 15px; }
        .check-item { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="logo.png" alt="Yaute Logo" class="splash-logo">
        <div class="splash-loader"></div>
    </div>

    <div id="custom-modal">
        <div class="modal-card">
            <h6 id="modal-title" class="fw-bold mb-3 text-uppercase">T√çTULO</h6>
            <div id="modal-body" class="mb-4"></div>
            <div class="d-flex gap-2">
                <button id="modal-cancel" class="btn btn-light flex-grow-1 fw-bold rounded-pill">CANCELAR</button>
                <button id="modal-ok" class="btn btn-primary flex-grow-1 fw-bold rounded-pill">ACEPTAR</button>
            </div>
        </div>
    </div>

    <div id="cam-container">
        <video id="cam-preview" autoplay playsinline muted></video>
        <button id="btn-cam-cancel" style="position:absolute; top:40px; right:20px; background:rgba(0,0,0,0.5); border:none; border-radius:50%; width:44px; height:44px; color:white;"><i class="fas fa-times"></i></button>
        <div class="cam-controls"><button id="btn-do-capture" class="btn-capture"></button></div>
        <canvas id="cam-canvas" style="display:none;"></canvas>
    </div>

    <div id="toast-alert"></div>

    <header>
        <h5 class="m-0 fw-bold">OFERTAS R√ÅPIDAS YAUTE <span id="status-dot" style="display:inline-block; width:10px; height:10px; border-radius:50%;" class="bg-warning"></span></h5>
    </header>

    <main>
        <!-- VENTA -->
        <div id="tab-operaciones" class="tab-content active">
            <div class="card-custom">
                <!-- BOT√ìN PUBLICADOR -->
                <button id="btn-publish" class="btn-publish-wa mb-3">
                    <i class="fab fa-whatsapp"></i> PUBLICAR PRODUCTO EN GRUPO
                </button>

                <div class="row g-2 mb-3">
                    <div class="col-6 position-relative">
                        <label class="text-uppercase">Tienda</label>
                        <input type="text" id="in-tienda" class="form-control text-uppercase fw-bold" placeholder="Walmart" autocomplete="off">
                        <div id="sug-tienda" class="sug-box d-none"></div>
                    </div>
                    <div class="col-6 position-relative">
                        <label class="text-uppercase">Cliente</label>
                        <input type="text" id="in-cliente" class="form-control text-uppercase" placeholder="Nombre" autocomplete="off">
                        <div id="sug-cliente" class="sug-box d-none"></div>
                    </div>
                </div>
                <hr class="opacity-10">
                <div class="row g-2 mb-3 align-items-end">
                    <div class="col-2">
                        <label class="text-uppercase">Cant.</label>
                        <input type="number" id="in-cantidad" class="form-control text-center fw-bold" value="1" min="1">
                    </div>
                    <div class="col position-relative">
                        <label class="text-uppercase">Producto (Lector IA)</label>
                        <input type="text" id="in-producto" class="form-control text-uppercase" placeholder="ESCANEAR O ESCRIBIR" autocomplete="off">
                        <div id="sug-producto" class="sug-box d-none"></div>
                    </div>
                    <div class="col-auto">
                        <button id="btn-scan" class="btn-inline-cam"><i class="fas fa-camera"></i></button>
                    </div>
                </div>
                <div class="row g-2 mb-4">
                    <div class="col-6">
                        <label class="text-uppercase">Costo</label>
                        <input type="number" id="in-costo" class="form-control fw-bold text-danger" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="col-6">
                        <label class="text-uppercase">Venta</label>
                        <input type="number" id="in-precio" class="form-control fw-bold text-success" placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>
                <button id="btn-save" class="btn btn-primary w-100 py-3 fw-bold rounded-3">GUARDAR REGISTRO</button>
            </div>
        </div>

        <!-- REPARTO -->
        <div id="tab-entregas" class="tab-content">
            <div class="card-custom py-2 mb-3"><input type="date" id="entregas-date" class="form-control text-center fw-bold"></div>
            <div id="lista-entregas"></div>
        </div>

        <!-- CONTROL -->
        <div id="tab-control" class="tab-content">
            <div class="sub-nav">
                <button class="sub-btn active" id="btn-sub-clients" data-sub="clientes">Clientes</button>
                <button class="sub-btn" id="btn-sub-products" data-sub="productos">Productos</button>
                <button class="sub-btn" id="btn-sub-sales" data-sub="sales">Ventas</button>
                <button class="sub-btn" id="btn-sub-profit" data-sub="ganancias">Ganancias</button>
                <button class="sub-btn" id="btn-sub-history" data-sub="historial">Historial</button>
                <button class="sub-btn" id="btn-sub-store" data-sub="ticketTienda">Ticket Tienda</button>
                <button class="sub-btn" id="btn-sub-diezmo" data-sub="diezmo">Diezmo</button>
            </div>
            <div id="filter-wrapper" class="mb-3"></div>
            <div id="lista-catalogos"></div>
        </div>
    </main>

    <!-- TICKET RENDER -->
    <div id="ticket-render">
        <img src="logo.png" alt="Yaute Logo" class="ticket-header-img">
        <div style="text-align: center; font-size: 1.3rem; font-weight: 900; margin-bottom: 5px;">OFERTAS RAPIDAS YAUTE</div>
        <div id="t-date-val" style="text-align: center; font-size: 1rem; margin-bottom: 15px;"></div>
        <div style="border-top: 3px solid #000; margin: 10px 0;"></div>
        <div style="font-size: 1.1rem; margin: 15px 0;"><b>CLIENTE:</b> <span id="t-cliente-name" style="text-transform: uppercase;"></span></div>
        <table style="width: 100%; border-collapse: collapse;"><tbody id="t-body-items"></tbody></table>
        <div style="border-top: 2px dashed #000; margin: 15px 0;"></div>
        <div style="font-size: 1.5rem; font-weight: 900; display: flex; justify-content: space-between;"><span>TOTAL:</span><span id="t-grand-total"></span></div>
        <div style="text-align: center; font-size: 0.9rem; color: #333; margin-top: 40px; text-transform: uppercase;">¬°Gracias por su preferencia!</div>
    </div>

    <nav class="bottom-nav">
        <button class="tab-btn active" data-tab="operaciones"><i class="fas fa-cash-register"></i>Venta</button>
        <button class="tab-btn" data-tab="entregas"><i class="fas fa-truck"></i>Reparto</button>
        <button class="tab-btn" data-tab="control"><i class="fas fa-history"></i>Control</button>
    </nav>

    <script type="module">
        // ==================== CONFIGURACI√ìN ====================
        // Usar la misma API key del proyecto para Gemini
        const GEMINI_API_KEY = "AIzaSyCR5V_yg6aLumW_D8oFPEblHZ5ox2gTs98";
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, deleteDoc, updateDoc, onSnapshot, writeBatch, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCR5V_yg6aLumW_D8oFPEblHZ5ox2gTs98",
            authDomain: "ofertas-rapidas-yautepec.firebaseapp.com",
            projectId: "ofertas-rapidas-yautepec",
            storageBucket: "ofertas-rapidas-yautepec.firebasestorage.app",
            messagingSenderId: "81339635207",
            appId: "1:81339635207:web:26d180f92224d9a036fca2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        // Usar Firestore con colecciones simples en lugar de rutas anidadas complejas
        const db = getFirestore(app);

        // ==================== ESTADO GLOBAL ====================
        const state = {
            sales: [],
            clients: [],
            stores: [],
            products: []
        };
        
        let activeSubTab = 'clientes';
        let lastCapturedBlob = null;
        let currentScanMode = 'register'; // 'register' o 'publish'
        
        // Referencias a colecciones
        const collections = {
            sales: collection(db, 'sales'),
            clients: collection(db, 'clients'),
            stores: collection(db, 'stores'),
            products: collection(db, 'products')
        };

        // ==================== UTILIDADES ====================
        const showToast = (msg, type = 'success') => {
            const toast = document.getElementById('toast-alert');
            toast.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        };

        // Formato de fecha consistente: YYYY-MM-DD
        const getISODate = (date = new Date()) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        // Convertir fecha ISO a formato local para mostrar (DD/MM/YYYY)
        const isoToLocalDate = (isoDate) => {
            if (!isoDate) return '';
            const [year, month, day] = isoDate.split('-');
            return `${day}/${month}/${year}`;
        };

        const openModal = (title, bodyHtml, onOk) => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = bodyHtml;
            modal.style.display = 'flex';
            
            const btnOk = document.getElementById('modal-ok');
            const btnCancel = document.getElementById('modal-cancel');
            
            // Limpiar eventos anteriores
            const newBtnOk = btnOk.cloneNode(true);
            const newBtnCancel = btnCancel.cloneNode(true);
            btnOk.parentNode.replaceChild(newBtnOk, btnOk);
            btnCancel.parentNode.replaceChild(newBtnCancel, btnCancel);
            
            newBtnOk.onclick = () => {
                const inputs = document.querySelectorAll('#modal-body input, #modal-body select');
                const results = Array.from(inputs).map(i => i.value);
                onOk(results);
                modal.style.display = 'none';
            };
            
            newBtnCancel.onclick = () => {
                modal.style.display = 'none';
            };
        };

        // ==================== C√ÅMARA ====================
        const camContainer = document.getElementById('cam-container');
        const camPreview = document.getElementById('cam-preview');
        const camCanvas = document.getElementById('cam-canvas');
        let stream = null;

        const startCamera = async (mode) => {
            currentScanMode = mode;
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', 
                        width: { ideal: 1280 } 
                    } 
                });
                camPreview.srcObject = stream;
                camContainer.style.display = 'block';
            } catch (e) {
                showToast("C√°mara no disponible", "danger");
                console.error(e);
            }
        };

        document.getElementById('btn-scan').onclick = () => startCamera('register');
        document.getElementById('btn-publish').onclick = () => startCamera('publish');
        
        document.getElementById('btn-cam-cancel').onclick = () => {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            camContainer.style.display = 'none';
        };

        document.getElementById('btn-do-capture').onclick = () => {
            const ctx = camCanvas.getContext('2d');
            // Usar dimensiones m√°s peque√±as para mejor rendimiento
            camCanvas.width = 640;
            camCanvas.height = 480;
            ctx.drawImage(camPreview, 0, 0, 640, 480);
            
            camCanvas.toBlob((blob) => {
                lastCapturedBlob = blob;
                const reader = new FileReader();
                
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    
                    // Detener c√°mara
                    if (stream) {
                        stream.getTracks().forEach(t => t.stop());
                        stream = null;
                    }
                    camContainer.style.display = 'none';
                    
                    // Procesar seg√∫n el modo
                    if (currentScanMode === 'publish') {
                        processPublishIA(base64);
                    } else {
                        processIA(base64);
                    }
                };
                
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.85);
        };

        // ==================== IA GEMINI ====================
        async function processIA(base64) {
            showToast("IA: Analizando...");
            
            try {
                const payload = {
                    contents: [{
                        parts: [
                            { text: "Extrae el nombre del producto y el costo unitario de esta etiqueta. Responde SOLO con JSON v√°lido en este formato: {'productName': string, 'unitCost': number}. Si no encuentras alg√∫n valor, usa null." },
                            { inlineData: { mimeType: "image/jpeg", data: base64 } }
                        ]
                    }]
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                
                // Validar respuesta
                if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                    throw new Error('Respuesta inv√°lida de la IA');
                }

                const textResponse = data.candidates[0].content.parts[0].text;
                // Limpiar la respuesta (puede venir con markdown)
                const jsonStr = textResponse.replace(/```json|```/g, '').trim();
                const result = JSON.parse(jsonStr);

                // Actualizar campos
                if (result.productName) {
                    document.getElementById('in-producto').value = result.productName.toUpperCase();
                }
                
                if (result.unitCost) {
                    document.getElementById('in-costo').value = result.unitCost;
                    
                    // Si el cliente es "CRISTO", copiar costo a precio
                    const clienteInput = document.getElementById('in-cliente');
                    if (clienteInput.value.toUpperCase() === "CRISTO") {
                        document.getElementById('in-precio').value = result.unitCost;
                    }
                }

                showToast("Etiqueta le√≠da correctamente");
                
            } catch (error) {
                console.error('Error en IA:', error);
                showToast("Error al procesar la imagen: " + error.message, "danger");
            }
        }

        async function processPublishIA(base64) {
            showToast("IA: Identificando producto...");
            
            try {
                const payload = {
                    contents: [{
                        parts: [
                            { text: "Analiza este producto comercial. Extrae el nombre y la presentaci√≥n. Responde SOLO con JSON v√°lido en este formato: {'name': string, 'presentation': string}. Usa null si no encuentras alg√∫n valor." },
                            { inlineData: { mimeType: "image/jpeg", data: base64 } }
                        ]
                    }]
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                    throw new Error('Respuesta inv√°lida de la IA');
                }

                const textResponse = data.candidates[0].content.parts[0].text;
                const jsonStr = textResponse.replace(/```json|```/g, '').trim();
                const result = JSON.parse(jsonStr);

                // Mostrar modal para completar la publicaci√≥n
                openModal(
                    "PUBLICAR EN GRUPO",
                    `<label class='text-uppercase small fw-bold'>Producto:</label>
                     <input type='text' id='wa-name' class='form-control mb-2 text-uppercase' value='${result.name || ''}'>
                     <label class='text-uppercase small fw-bold'>Presentaci√≥n:</label>
                     <input type='text' id='wa-pres' class='form-control mb-2 text-uppercase' value='${result.presentation || ''}'>
                     <label class='text-uppercase small fw-bold'>Precio:</label>
                     <input type='text' id='wa-price' class='form-control' placeholder='Ej: $35.00'>`,
                    async (values) => {
                        const name = values[0]?.toUpperCase() || '';
                        const pres = values[1]?.toUpperCase() || '';
                        const price = values[2] || '';
                        
                        const msg = `‚ö° ¬°NUEVA OFERTA! ‚ö°\n\nüì¶ *${name}*\n‚öñÔ∏è Presentaci√≥n: ${pres}\n${price ? 'üí∞ *Precio: ' + price + '*\n' : ''}\nüõí ¬°Disponible ahora!`;
                        
                        try {
                            if (navigator.share && lastCapturedBlob) {
                                const file = new File([lastCapturedBlob], `oferta.jpg`, { type: 'image/jpeg' });
                                await navigator.share({
                                    files: [file],
                                    title: 'Oferta Yaute',
                                    text: msg
                                });
                                showToast("¬°Compartido!");
                            } else {
                                // Fallback: copiar al portapapeles
                                await navigator.clipboard.writeText(msg);
                                showToast("Mensaje copiado al portapapeles");
                            }
                        } catch (shareError) {
                            console.error('Error al compartir:', shareError);
                            showToast("No se pudo compartir", "danger");
                        }
                    }
                );

            } catch (error) {
                console.error('Error en IA de publicaci√≥n:', error);
                showToast("Error al identificar producto", "danger");
            }
        }

        // ==================== FIREBASE SYNC ====================
        signInAnonymously(auth);
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('status-dot').className = 'bg-success';
                document.getElementById('entregas-date').value = getISODate();
                startSync();
                setTimeout(() => {
                    document.getElementById('splash-screen').style.display = 'none';
                }, 1000);
            } else {
                document.getElementById('status-dot').className = 'bg-warning';
            }
        });

        const startSync = () => {
            // Escuchar cambios en todas las colecciones
            Object.keys(collections).forEach(key => {
                const q = query(collections[key], orderBy('nombre', 'asc'));
                
                onSnapshot(q, (snapshot) => {
                    state[key] = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Actualizar vistas seg√∫n sea necesario
                    if (key === 'sales') {
                        renderEntregas();
                    }
                    renderCatalogList();
                    
                    // Actualizar opciones de filtros
                    updateFilterOptions();
                }, (error) => {
                    console.error(`Error syncing ${key}:`, error);
                    showToast(`Error al sincronizar ${key}`, 'danger');
                });
            });

            // Configurar autocompletados
            setupAutoComplete('in-tienda', 'sug-tienda', 'stores');
            setupAutoComplete('in-cliente', 'sug-cliente', 'clients');
            setupAutoComplete('in-producto', 'sug-producto', 'products');
        };

        // ==================== AUTOCOMPLETADO ====================
        const setupAutoComplete = (inputId, suggestionsId, stateKey) => {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            
            if (!input || !suggestions) return;

            const handler = (e) => {
                const value = e.target.value.toUpperCase().trim();
                
                if (value.length < 1) {
                    suggestions.classList.add('d-none');
                    return;
                }

                const matches = (state[stateKey] || [])
                    .filter(item => (item.nombre || '').toUpperCase().includes(value))
                    .slice(0, 5);

                if (matches.length === 0) {
                    suggestions.classList.add('d-none');
                    return;
                }

                suggestions.innerHTML = matches
                    .map(item => `<div class="sug-item" data-value="${item.nombre}">${item.nombre}</div>`)
                    .join('');
                
                suggestions.classList.remove('d-none');
            };

            input.addEventListener('input', handler);
            input.addEventListener('focus', handler);

            // Cerrar sugerencias al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.classList.add('d-none');
                }
            });

            // Manejar clic en sugerencias
            suggestions.addEventListener('click', (e) => {
                const item = e.target.closest('.sug-item');
                if (!item) return;

                const value = item.dataset.value;
                input.value = value;
                suggestions.classList.add('d-none');

                // Si es producto, cargar costo y precio
                if (stateKey === 'products') {
                    const product = state.products.find(p => p.nombre === value);
                    if (product) {
                        if (product.pCosto) document.getElementById('in-costo').value = product.pCosto;
                        if (product.pVenta) document.getElementById('in-precio').value = product.pVenta;
                    }
                }

                // Disparar evento change para actualizar otros campos si es necesario
                input.dispatchEvent(new Event('change'));
            });
        };

        // ==================== NAVEGACI√ìN ====================
        // Tabs principales
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.getElementById(`tab-${tabId}`).classList.add('active');
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // Subtabs de control
        document.querySelectorAll('.sub-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const subId = btn.dataset.sub;
                
                document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                switchSubTab(subId);
            });
        });

        const switchSubTab = (subId) => {
            activeSubTab = subId;
            
            const filterWrapper = document.getElementById('filter-wrapper');
            const today = getISODate();
            
            // Generar filtros seg√∫n subtab
            let filterHtml = '';
            
            switch (subId) {
                case 'clientes':
                case 'productos':
                    filterHtml = '<input type="text" id="search-cat" class="form-control" placeholder="Buscar...">';
                    break;
                    
                case 'sales':
                    filterHtml = `
                        <div class="row g-2">
                            <div class="col-12 mb-2">
                                <input type="date" id="hist-date" class="form-control" value="${today}">
                            </div>
                            <div class="col-6">
                                <select id="filter-store" class="form-select"></select>
                            </div>
                            <div class="col-6">
                                <select id="filter-client" class="form-select"></select>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'ganancias':
                    filterHtml = `<input type="date" id="hist-date" class="form-control text-center" value="${today}">`;
                    break;
                    
                case 'historial':
                    filterHtml = '<div class="text-center small opacity-50 py-1">Historial total por fecha</div>';
                    break;
                    
                case 'ticketTienda':
                    filterHtml = `
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="date" id="st-date" class="form-control" value="${today}">
                            </div>
                            <div class="col-6">
                                <select id="st-store" class="form-select"></select>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'diezmo':
                    filterHtml = `
                        <div class="d-flex gap-2">
                            <input type="date" id="d-start" class="form-control" value="${today}">
                            <input type="date" id="d-end" class="form-control" value="${today}">
                        </div>
                    `;
                    break;
            }
            
            filterWrapper.innerHTML = filterHtml;
            
            // Agregar event listeners a los nuevos filtros
            setTimeout(() => {
                updateFilterOptions();
                
                // Agregar listeners para b√∫squeda
                const searchInput = document.getElementById('search-cat');
                if (searchInput) {
                    searchInput.addEventListener('input', renderCatalogList);
                }
                
                // Listeners para fechas y selects
                ['hist-date', 'st-date', 'd-start', 'd-end', 'filter-store', 'filter-client', 'st-store'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('change', renderCatalogList);
                        el.addEventListener('input', renderCatalogList);
                    }
                });
                
                renderCatalogList();
            }, 50);
        };

        const updateFilterOptions = () => {
            // Actualizar selects de tiendas
            const storeSelects = ['filter-store', 'st-store'];
            const storeOptions = ['<option value="">TODAS LAS TIENDAS</option>'];
            
            const uniqueStores = [...new Set(state.stores.map(s => s.nombre))].sort();
            uniqueStores.forEach(store => {
                storeOptions.push(`<option value="${store}">${store}</option>`);
            });
            
            storeSelects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const currentVal = select.value;
                    select.innerHTML = storeOptions.join('');
                    if (currentVal) select.value = currentVal;
                }
            });
            
            // Actualizar selects de clientes
            const clientSelect = document.getElementById('filter-client');
            if (clientSelect) {
                const clientOptions = ['<option value="">TODOS LOS CLIENTES</option>'];
                const uniqueClients = [...new Set(state.clients.map(c => c.nombre))].sort();
                uniqueClients.forEach(client => {
                    clientOptions.push(`<option value="${client}">${client}</option>`);
                });
                const currentVal = clientSelect.value;
                clientSelect.innerHTML = clientOptions.join('');
                if (currentVal) clientSelect.value = currentVal;
            }
        };

        // ==================== RENDERIZADO DE VISTAS ====================
        window.renderEntregas = () => {
            const list = document.getElementById('lista-entregas');
            if (!list) return;

            const selectedDate = document.getElementById('entregas-date').value;
            if (!selectedDate) return;

            // Filtrar ventas de la fecha seleccionada
            const filtered = state.sales.filter(s => s.fechaStr === selectedDate);

            if (filtered.length === 0) {
                list.innerHTML = '<p class="text-center py-5 opacity-50">Sin pedidos para esta fecha</p>';
                return;
            }

            // Agrupar por cliente
            const grouped = {};
            filtered.forEach(sale => {
                if (!grouped[sale.cliente]) {
                    grouped[sale.cliente] = {
                        total: 0,
                        items: [],
                        entregado: sale.entregado || false,
                        pagado: sale.pagado || false
                    };
                }
                grouped[sale.cliente].total += sale.total || 0;
                grouped[sale.cliente].items.push(sale);
                // Mantener estado de entregado/pagado (si todos los items est√°n marcados)
                grouped[sale.cliente].entregado = grouped[sale.cliente].entregado && (sale.entregado || false);
                grouped[sale.cliente].pagado = grouped[sale.cliente].pagado && (sale.pagado || false);
            });

            list.innerHTML = Object.keys(grouped).map(cliente => {
                const group = grouped[cliente];
                const allCheckedEntregado = group.items.every(i => i.entregado);
                const allCheckedPagado = group.items.every(i => i.pagado);
                
                return `
                    <div class="card-custom">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="fw-bold mb-0">${cliente}</h6>
                            <button class="btn btn-sm btn-success rounded-pill px-3" onclick="shareTicket('${cliente}')">
                                <i class="fab fa-whatsapp"></i> Ticket
                            </button>
                        </div>
                        
                        <div class="check-group mb-2">
                            <label class="check-item">
                                <input type="checkbox" class="status-check" data-cliente="${cliente}" data-field="entregado" ${allCheckedEntregado ? 'checked' : ''}> 
                                ENTREGA COMPLETA
                            </label>
                            <label class="check-item">
                                <input type="checkbox" class="status-check" data-cliente="${cliente}" data-field="pagado" ${allCheckedPagado ? 'checked' : ''}> 
                                PAGO COMPLETO
                            </label>
                        </div>
                        
                        <div class="small">
                            ${group.items.map(i => `
                                <div class="d-flex justify-content-between">
                                    <span>‚ö° ${i.cantidad || 1}x ${i.producto}</span>
                                    <span>$${(i.total || 0).toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="text-end fw-bold text-primary mt-2 border-top pt-1">
                            TOTAL: $${group.total.toFixed(2)}
                        </div>
                    </div>
                `;
            }).join('');

            // Agregar event listeners a los checkboxes
            document.querySelectorAll('.status-check').forEach(cb => {
                cb.addEventListener('change', async (e) => {
                    const cliente = e.target.dataset.cliente;
                    const field = e.target.dataset.field;
                    const checked = e.target.checked;
                    
                    await toggleBulkStatus(cliente, selectedDate, field, checked);
                });
            });
        };

        const toggleBulkStatus = async (cliente, fecha, field, value) => {
            try {
                const itemsToUpdate = state.sales.filter(s => 
                    s.cliente === cliente && s.fechaStr === fecha
                );

                if (itemsToUpdate.length === 0) return;

                const batch = writeBatch(db);
                
                itemsToUpdate.forEach(item => {
                    const ref = doc(db, 'sales', item.id);
                    batch.update(ref, { [field]: value });
                });

                await batch.commit();
                showToast(`Estado actualizado para ${cliente}`);
                
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('Error al actualizar estado', 'danger');
            }
        };

        window.shareTicket = async (cliente) => {
            const selectedDate = document.getElementById('entregas-date').value;
            if (!selectedDate) return;

            const items = state.sales.filter(s => 
                s.cliente === cliente && s.fechaStr === selectedDate
            );

            if (items.length === 0) return;

            // Preparar ticket
            document.getElementById('t-cliente-name').innerText = cliente;
            document.getElementById('t-date-val').innerText = isoToLocalDate(selectedDate);
            
            let total = 0;
            const itemsHtml = items.map(item => {
                const subtotal = item.total || (item.cantidad * item.precio) || 0;
                total += subtotal;
                return `<tr>
                    <td style="width:40px">${item.cantidad || 1}x</td>
                    <td style="text-transform:uppercase">${item.producto}</td>
                    <td style="text-align:right">$${subtotal.toFixed(2)}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('t-body-items').innerHTML = itemsHtml;
            document.getElementById('t-grand-total').innerText = total.toFixed(2);

            try {
                const canvas = await html2canvas(document.getElementById('ticket-render'), {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false
                });

                canvas.toBlob(async (blob) => {
                    if (!blob) return;
                    
                    const file = new File([blob], `Ticket_${cliente}.png`, { type: 'image/png' });
                    
                    const nombreFormateado = cliente.toLowerCase()
                        .split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                    
                    try {
                        if (navigator.share) {
                            await navigator.share({
                                files: [file],
                                title: 'Ticket de compra',
                                text: `Hola ${nombreFormateado}, aqu√≠ est√° tu ticket.`
                            });
                        } else {
                            // Fallback: descargar imagen
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `Ticket_${cliente}.png`;
                            a.click();
                            URL.revokeObjectURL(url);
                            showToast('Ticket descargado');
                        }
                    } catch (shareError) {
                        console.error('Error sharing:', shareError);
                        showToast('No se pudo compartir', 'danger');
                    }
                }, 'image/png');
                
            } catch (error) {
                console.error('Error generating ticket:', error);
                showToast('Error al generar ticket', 'danger');
            }
        };

        // ==================== RENDERIZADO DE CAT√ÅLOGOS ====================
        const renderCatalogList = () => {
            const list = document.getElementById('lista-catalogos');
            if (!list) return;

            const searchTerm = document.getElementById('search-cat')?.value?.toUpperCase() || '';

            switch (activeSubTab) {
                case 'clientes':
                    renderClients(list, searchTerm);
                    break;
                case 'productos':
                    renderProducts(list, searchTerm);
                    break;
                case 'sales':
                    renderSales(list);
                    break;
                case 'ganancias':
                    renderGanancias(list);
                    break;
                case 'historial':
                    renderHistorial(list);
                    break;
                case 'ticketTienda':
                    renderTicketTienda(list);
                    break;
                case 'diezmo':
                    renderDiezmo(list);
                    break;
            }
        };

        const renderClients = (list, searchTerm) => {
            const filtered = state.clients
                .filter(c => !searchTerm || (c.nombre || '').toUpperCase().includes(searchTerm))
                .sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''));

            list.innerHTML = filtered.map(c => `
                <div class="card-custom d-flex justify-content-between align-items-center">
                    <span class="fw-bold">${c.nombre || 'SIN NOMBRE'}</span>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm text-primary" onclick="editClient('${c.id}', '${c.nombre}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm text-danger" onclick="deleteClient('${c.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        };

        const renderProducts = (list, searchTerm) => {
            const filtered = state.products
                .filter(p => !searchTerm || (p.nombre || '').toUpperCase().includes(searchTerm))
                .sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''));

            list.innerHTML = filtered.map(p => `
                <div class="card-custom">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="fw-bold">${p.nombre || 'SIN NOMBRE'}</span>
                            <div class="small text-muted mt-1">
                                <span>Costo: $${(p.pCosto || 0).toFixed(2)}</span>
                                <span class="ms-3">Venta: $${(p.pVenta || 0).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm text-primary" onclick="editProduct('${p.id}', '${p.nombre}', ${p.pCosto || 0}, ${p.pVenta || 0})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm text-danger" onclick="deleteProduct('${p.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        const renderSales = (list) => {
            const dateInput = document.getElementById('hist-date');
            const storeFilter = document.getElementById('filter-store');
            const clientFilter = document.getElementById('filter-client');
            
            if (!dateInput) return;
            
            const selectedDate = dateInput.value;
            const selectedStore = storeFilter?.value || '';
            const selectedClient = clientFilter?.value || '';

            let filtered = state.sales.filter(s => s.fechaStr === selectedDate);
            
            if (selectedStore) {
                filtered = filtered.filter(s => s.tienda === selectedStore);
            }
            
            if (selectedClient) {
                filtered = filtered.filter(s => s.cliente === selectedClient);
            }

            const total = filtered.reduce((sum, s) => sum + (s.total || 0), 0);

            list.innerHTML = filtered.map(s => `
                <div class="card-custom">
                    <div class="d-flex justify-content-between">
                        <div>
                            <span class="fw-bold">${s.cantidad || 1}x ${s.producto}</span>
                            <div class="small text-muted">
                                ${s.tienda} ‚Ä¢ ${s.cliente}
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold">$${(s.total || 0).toFixed(2)}</span>
                            <button class="btn btn-sm text-danger d-block mt-1" onclick="deleteSale('${s.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') + `
                <div class="card-custom bg-primary text-white">
                    <div class="d-flex justify-content-between fw-bold">
                        <span>TOTAL VENTAS</span>
                        <span>$${total.toFixed(2)}</span>
                    </div>
                </div>
            `;
        };

        const renderGanancias = (list) => {
            const dateInput = document.getElementById('hist-date');
            if (!dateInput) return;
            
            const selectedDate = dateInput.value;
            
            const filtered = state.sales.filter(s => s.fechaStr === selectedDate);
            
            const profitsByStore = {};
            let totalProfit = 0;
            
            filtered.forEach(sale => {
                const store = sale.tienda || 'SIN TIENDA';
                const cost = (sale.costo || 0) * (sale.cantidad || 1);
                const revenue = sale.total || (sale.cantidad * sale.precio) || 0;
                const profit = revenue - cost;
                
                if (!profitsByStore[store]) {
                    profitsByStore[store] = 0;
                }
                profitsByStore[store] += profit;
                totalProfit += profit;
            });

            list.innerHTML = Object.keys(profitsByStore).map(store => `
                <div class="card-custom d-flex justify-content-between">
                    <span class="fw-bold">${store}</span>
                    <span class="text-success fw-bold">$${profitsByStore[store].toFixed(2)}</span>
                </div>
            `).join('') + `
                <div class="card-custom bg-success text-white">
                    <div class="d-flex justify-content-between fw-bold">
                        <span>GANANCIA TOTAL D√çA</span>
                        <span>$${totalProfit.toFixed(2)}</span>
                    </div>
                </div>
            `;
        };

        const renderHistorial = (list) => {
            const historyByDate = {};
            
            state.sales.forEach(sale => {
                if (!sale.fechaStr) return;
                
                if (!historyByDate[sale.fechaStr]) {
                    historyByDate[sale.fechaStr] = {
                        ventas: 0,
                        ganancias: 0
                    };
                }
                
                const revenue = sale.total || (sale.cantidad * sale.precio) || 0;
                const cost = (sale.costo || 0) * (sale.cantidad || 1);
                
                historyByDate[sale.fechaStr].ventas += revenue;
                historyByDate[sale.fechaStr].ganancias += (revenue - cost);
            });

            const sortedDates = Object.keys(historyByDate).sort().reverse();

            list.innerHTML = sortedDates.map(date => `
                <div class="card-custom">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold">${isoToLocalDate(date)}</span>
                        <span class="badge bg-primary">Ventas: $${historyByDate[date].ventas.toFixed(2)}</span>
                        <span class="badge bg-success">Ganancias: $${historyByDate[date].ganancias.toFixed(2)}</span>
                    </div>
                </div>
            `).join('') || '<p class="text-center py-4">Sin historial</p>';
        };

        const renderTicketTienda = (list) => {
            const dateInput = document.getElementById('st-date');
            const storeSelect = document.getElementById('st-store');
            
            if (!dateInput || !storeSelect) return;
            
            const selectedDate = dateInput.value;
            const selectedStore = storeSelect.value;
            
            if (!selectedStore) {
                list.innerHTML = '<p class="text-center py-4">Selecciona una tienda</p>';
                return;
            }

            const filtered = state.sales.filter(s => 
                s.fechaStr === selectedDate && s.tienda === selectedStore
            );

            const totalCosto = filtered.reduce((sum, s) => 
                sum + ((s.costo || 0) * (s.cantidad || 1)), 0
            );

            list.innerHTML = `
                <div class="card-custom">
                    <h6 class="fw-bold mb-3">${selectedStore}</h6>
                    <hr>
                    ${filtered.map(s => `
                        <div class="d-flex justify-content-between py-1">
                            <span>${s.cantidad || 1}x ${s.producto}</span>
                            <span class="fw-bold">$${((s.costo || 0) * (s.cantidad || 1)).toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>TOTAL COSTO</span>
                        <span>$${totalCosto.toFixed(2)}</span>
                    </div>
                </div>
            `;
        };

        const renderDiezmo = (list) => {
            const startInput = document.getElementById('d-start');
            const endInput = document.getElementById('d-end');
            
            if (!startInput || !endInput) return;
            
            const startDate = startInput.value;
            const endDate = endInput.value;
            
            if (!startDate || !endDate) return;

            const filtered = state.sales.filter(s => 
                s.fechaStr && s.fechaStr >= startDate && s.fechaStr <= endDate
            );

            const totalGanancias = filtered.reduce((sum, s) => {
                const revenue = s.total || (s.cantidad * s.precio) || 0;
                const cost = (s.costo || 0) * (s.cantidad || 1);
                return sum + (revenue - cost);
            }, 0);

            const diezmo = totalGanancias * 0.1;

            list.innerHTML = `
                <div class="card-custom bg-warning text-dark">
                    <div class="text-center mb-3">
                        <span class="fw-bold">PER√çODO: ${isoToLocalDate(startDate)} - ${isoToLocalDate(endDate)}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Ganancias totales:</span>
                        <span class="fw-bold">$${totalGanancias.toFixed(2)}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Diezmo (10%):</span>
                        <span class="fw-bold text-danger">$${diezmo.toFixed(2)}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>NETO:</span>
                        <span>$${(totalGanancias - diezmo).toFixed(2)}</span>
                    </div>
                </div>
            `;
        };

        // ==================== ACCIONES CRUD ====================
        window.deleteSale = async (id) => {
            if (!confirm('¬øEliminar esta venta?')) return;
            
            try {
                await deleteDoc(doc(db, 'sales', id));
                showToast('Venta eliminada');
            } catch (error) {
                console.error('Error deleting sale:', error);
                showToast('Error al eliminar', 'danger');
            }
        };

        window.editClient = (id, currentName) => {
            openModal(
                'EDITAR CLIENTE',
                `<input type="text" id="edit-client-name" class="form-control text-uppercase" value="${currentName}">`,
                async (values) => {
                    const newName = values[0]?.toUpperCase().trim();
                    if (!newName) return;
                    
                    try {
                        // Actualizar cliente
                        await updateDoc(doc(db, 'clients', id), { nombre: newName });
                        
                        // Actualizar todas las ventas de este cliente
                        const salesToUpdate = state.sales.filter(s => s.cliente === currentName);
                        
                        if (salesToUpdate.length > 0) {
                            const batch = writeBatch(db);
                            salesToUpdate.forEach(sale => {
                                const ref = doc(db, 'sales', sale.id);
                                batch.update(ref, { cliente: newName });
                            });
                            await batch.commit();
                        }
                        
                        showToast('Cliente actualizado');
                    } catch (error) {
                        console.error('Error updating client:', error);
                        showToast('Error al actualizar', 'danger');
                    }
                }
            );
        };

        window.deleteClient = async (id) => {
            const client = state.clients.find(c => c.id === id);
            if (!client) return;
            
            // Verificar si tiene ventas
            const hasSales = state.sales.some(s => s.cliente === client.nombre);
            
            if (hasSales) {
                if (!confirm('Este cliente tiene ventas. ¬øEliminar de todas formas?')) return;
            } else {
                if (!confirm('¬øEliminar este cliente?')) return;
            }
            
            try {
                await deleteDoc(doc(db, 'clients', id));
                showToast('Cliente eliminado');
            } catch (error) {
                console.error('Error deleting client:', error);
                showToast('Error al eliminar', 'danger');
            }
        };

        window.editProduct = (id, currentName, currentCosto, currentVenta) => {
            openModal(
                'EDITAR PRODUCTO',
                `
                <input type="text" id="edit-prod-name" class="form-control mb-2 text-uppercase" value="${currentName}">
                <input type="number" id="edit-prod-costo" class="form-control mb-2" value="${currentCosto}" step="0.01" min="0">
                <input type="number" id="edit-prod-venta" class="form-control" value="${currentVenta}" step="0.01" min="0">
                `,
                async (values) => {
                    const newName = values[0]?.toUpperCase().trim();
                    const newCosto = parseFloat(values[1]) || 0;
                    const newVenta = parseFloat(values[2]) || 0;
                    
                    if (!newName) return;
                    
                    try {
                        await updateDoc(doc(db, 'products', id), {
                            nombre: newName,
                            pCosto: newCosto,
                            pVenta: newVenta
                        });
                        showToast('Producto actualizado');
                    } catch (error) {
                        console.error('Error updating product:', error);
                        showToast('Error al actualizar', 'danger');
                    }
                }
            );
        };

        window.deleteProduct = async (id) => {
            const product = state.products.find(p => p.id === id);
            if (!product) return;
            
            // Verificar si tiene ventas
            const hasSales = state.sales.some(s => s.producto === product.nombre);
            
            if (hasSales) {
                if (!confirm('Este producto tiene ventas. ¬øEliminar de todas formas?')) return;
            } else {
                if (!confirm('¬øEliminar este producto?')) return;
            }
            
            try {
                await deleteDoc(doc(db, 'products', id));
                showToast('Producto eliminado');
            } catch (error) {
                console.error('Error deleting product:', error);
                showToast('Error al eliminar', 'danger');
            }
        };

        // ==================== GUARDAR VENTA ====================
        document.getElementById('btn-save').onclick = async () => {
            // Obtener y validar datos
            const tienda = document.getElementById('in-tienda').value.trim().toUpperCase();
            const cliente = document.getElementById('in-cliente').value.trim().toUpperCase();
            const producto = document.getElementById('in-producto').value.trim().toUpperCase();
            const cantidad = parseInt(document.getElementById('in-cantidad').value) || 1;
            const costo = parseFloat(document.getElementById('in-costo').value) || 0;
            const precio = parseFloat(document.getElementById('in-precio').value) || 0;
            
            if (!tienda || !producto) {
                showToast('Tienda y producto son obligatorios', 'danger');
                return;
            }

            const total = cantidad * precio;
            const fechaStr = getISODate();

            try {
                const batch = writeBatch(db);

                // 1. Guardar venta
                const saleRef = doc(collection(db, 'sales'));
                batch.set(saleRef, {
                    tienda,
                    cliente: cliente || 'SIN CLIENTE',
                    producto,
                    cantidad,
                    costo,
                    precio,
                    total,
                    fechaStr,
                    entregado: false,
                    pagado: false,
                    timestamp: serverTimestamp()
                });

                // 2. Actualizar/crear tienda si es nueva
                if (!state.stores.some(s => s.nombre === tienda)) {
                    const storeRef = doc(collection(db, 'stores'));
                    batch.set(storeRef, { nombre: tienda });
                }

                // 3. Actualizar/crear cliente si es nuevo y no es vac√≠o
                if (cliente && !state.clients.some(c => c.nombre === cliente)) {
                    const clientRef = doc(collection(db, 'clients'));
                    batch.set(clientRef, { nombre: cliente });
                }

                // 4. Actualizar/crear producto
                const existingProduct = state.products.find(p => p.nombre === producto);
                if (existingProduct) {
                    const productRef = doc(db, 'products', existingProduct.id);
                    batch.update(productRef, {
                        pCosto: costo,
                        pVenta: precio
                    });
                } else {
                    const productRef = doc(collection(db, 'products'));
                    batch.set(productRef, {
                        nombre: producto,
                        pCosto: costo,
                        pVenta: precio
                    });
                }

                // Ejecutar batch
                await batch.commit();

                // Limpiar campos de producto
                document.getElementById('in-producto').value = '';
                document.getElementById('in-costo').value = '';
                document.getElementById('in-precio').value = '';
                
                showToast('¬°Venta guardada!');
                
            } catch (error) {
                console.error('Error saving sale:', error);
                showToast('Error al guardar: ' + error.message, 'danger');
            }
        };

        // Hacer funciones globales para acceso desde HTML
        window.renderCatalogList = renderCatalogList;
        window.shareTicket = shareTicket;
        window.deleteSale = deleteSale;
        window.editClient = editClient;
        window.deleteClient = deleteClient;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
    </script>
</body>
</html>