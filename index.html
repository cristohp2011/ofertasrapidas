<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ofertas Rápidas Yaute v10.17</title>
    
    <!-- Librerías de confianza -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #0f172a;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --whatsapp: #25d366;
            --bg: #f8fafc;
            --card-radius: 12px;
        }

        body { 
            background-color: var(--bg); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            padding-bottom: 80px;
            user-select: none;
            color: #1e293b;
        }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; inset: 0; background: #ffffff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.8s ease, visibility 0.8s;
        }
        .splash-logo { width: 120px; height: auto; margin-bottom: 20px; animation: pulse 2s infinite ease-in-out; }
        .splash-title { font-weight: 900; color: var(--primary); font-size: 1.4rem; text-transform: uppercase; }
        .splash-loader { margin-top: 30px; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- HEADER & UI --- */
        header { background: var(--primary); color: white; padding: 0.5rem 1rem; position: sticky; top: 0; z-index: 1000; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .header-container { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .app-logo { height: 28px; width: auto; object-fit: contain; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 5px currentColor; }

        .card-custom { background: white; border-radius: var(--card-radius); padding: 15px; margin-bottom: 12px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-left: 4px solid transparent; }
        .card-entrega-pagado { background-color: #f0fdf4 !important; border-left-color: var(--success); }
        .card-entrega-enviado { background-color: #fff1f2 !important; border-left-color: var(--danger); }
        .card-entrega-completo { background-color: #ecfdf5 !important; border-left-color: #059669; opacity: 0.9; }

        #toast-alert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10001; padding: 12px 24px; border-radius: 50px; font-weight: 700; display: none; color: white; text-align: center; min-width: 250px; font-size: 0.85rem; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { transform: translate(-50%, -100px); } to { transform: translate(-50%, 0); } }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-control { padding: 0.5rem 0.7rem; font-size: 0.9rem; border-radius: 8px; border: 1px solid #e2e8f0; }
        .filter-input { width: 100%; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px 10px; font-size: 0.8rem; background: white; }
        label.text-uppercase { font-size: 0.65rem; margin-bottom: 4px; font-weight: 800; color: #64748b; display: block; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px); display: flex; justify-content: space-around; padding: 8px 0 20px; border-top: 1px solid #e2e8f0; z-index: 2000; }
        .tab-btn { background: none; border: none; color: #94a3b8; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; flex: 1; }
        .tab-btn i { font-size: 1.4rem; margin-bottom: 2px; }
        .tab-btn.active { color: var(--accent); font-weight: 800; }

        .sub-nav { display: flex; gap: 8px; overflow-x: auto; padding: 5px 10px 10px; scrollbar-width: none; }
        .sub-btn { background: white; border: 1px solid #e2e8f0; border-radius: 15px; padding: 6px 14px; font-size: 0.7rem; white-space: nowrap; color: #64748b; font-weight: 600; }
        .sub-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .search-wrapper { position: relative; }
        .sug-box { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 10px; max-height: 200px; overflow-y: auto; z-index: 1500; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-top: 4px; border: 1px solid #f1f5f9; }
        .sug-item { padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; font-size: 0.85rem; }

        /* --- CAMERA VIEW STYLES --- */
        #camera-overlay {
            position: fixed; inset: 0; background: #000; z-index: 10000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #camera-video { width: 100%; height: 100%; object-fit: cover; }
        
        .camera-guide {
            position: absolute; width: 92%; height: 220px;
            border: 2px solid rgba(255,255,255,0.9); border-radius: 15px;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.45); pointer-events: none;
        }
        .camera-guide::before {
            content: "ENCUADRE NOMBRE Y PRECIO GRANDE"; position: absolute; top: -35px; left: 0; right: 0;
            text-align: center; color: white; font-size: 0.75rem; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .camera-capture-btn {
            position: absolute; bottom: 40px; width: 85px; height: 85px;
            background: white; border: 8px solid rgba(59, 130, 246, 0.4);
            border-radius: 50%; color: var(--primary); font-size: 1.8rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .camera-capture-btn:active { transform: scale(0.9); background: #eee; }

        .camera-close {
            position: absolute; top: 40px; right: 20px; background: rgba(0,0,0,0.4);
            color: white; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 1.4rem;
            display: flex; align-items: center; justify-content: center;
        }

        .btn-scan {
            background: #eff6ff; color: var(--accent); border: 2px solid #3b82f6; border-radius: 12px; padding: 14px;
            display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9rem; font-weight: 900;
            width: 100%; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        .btn-scan.processing { background: #f8fafc; color: #94a3b8; border-color: #e2e8f0; pointer-events: none; }

        #ticket-render { position: fixed; left: -10000px; width: 320px; background: white; padding: 20px; color: black; font-family: 'Courier New', Courier, monospace; text-align: center; }
        .ticket-logo { width: 160px; height: auto; display: block; margin: 0 auto 10px; object-fit: contain; }
        .ticket-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
        .ticket-table { width: 100%; font-size: 0.85rem; margin-bottom: 15px; border-collapse: collapse; }
        .ticket-total { display: flex; justify-content: space-between; font-weight: 900; font-size: 1.1rem; border-top: 1px dashed #000; padding-top: 10px; }
    </style>
</head>
<body>

    <!-- --- SPLASH SCREEN --- -->
    <div id="splash-screen">
        <img src="logo.png" alt="Yaute Logo" class="splash-logo">
        <div class="splash-title">Ofertas Rápidas Yaute</div>
        <div class="splash-version">CONTROL PRO v10.17</div>
        <div class="splash-loader"></div>
    </div>

    <!-- --- INTERFAZ DE CÁMARA MEJORADA --- -->
    <div id="camera-overlay">
        <video id="camera-video" autoplay playsinline muted></video>
        <div class="camera-guide"></div>
        <button id="camera-capture" class="camera-capture-btn">
            <i class="fas fa-camera"></i>
        </button>
        <button id="camera-close" class="camera-close"><i class="fas fa-times"></i></button>
        <canvas id="camera-canvas" style="display:none;"></canvas>
    </div>

    <div id="toast-alert"></div>

    <header>
        <div class="header-container">
            <h5 class="m-0 fw-extrabold text-uppercase" style="font-size: 0.8rem;">Ofertas Rápidas Yaute</h5>
            <img id="main-logo" src="logo.png" alt="Logo" class="app-logo" style="display:none;" onload="this.style.display='block'">
            <div id="status-dot" class="status-indicator bg-warning"></div>
        </div>
    </header>

    <div class="container py-2">
        <!-- VENTA (Operaciones) -->
        <div id="tab-operaciones" class="tab-content active">
            <div class="card-custom">
                <div class="row g-2 mb-2">
                    <div class="col-6 search-wrapper">
                        <label class="text-uppercase">Tienda</label>
                        <input type="text" id="in-tienda" class="form-control text-uppercase fw-bold text-primary" placeholder="Tienda">
                        <div id="sug-tienda" class="sug-box d-none"></div>
                    </div>
                    <div class="col-6 search-wrapper">
                        <label class="text-uppercase">Cliente</label>
                        <input type="text" id="in-cliente" class="form-control text-uppercase" placeholder="Cliente">
                        <div id="sug-cliente" class="sug-box d-none"></div>
                    </div>
                </div>

                <hr class="my-3 opacity-10">
                
                <button id="btn-scan" class="btn-scan">
                    <i class="fas fa-expand"></i>
                    <span id="scan-text">FOTOGRAFIAR ETIQUETA</span>
                </button>

                <div class="row g-2 mb-3">
                    <div class="col-9 search-wrapper">
                        <label class="text-uppercase">Nombre + Presentación</label>
                        <input type="text" id="in-producto" class="form-control text-uppercase" placeholder="Producto">
                        <div id="sug-producto" class="sug-box d-none"></div>
                    </div>
                    <div class="col-3">
                        <label class="text-uppercase">Cant.</label>
                        <input type="number" id="in-cantidad" class="form-control text-center" value="1">
                    </div>
                    <div class="col-6">
                        <label class="text-uppercase">Costo (Núm. Grande)</label>
                        <input type="number" id="in-costo" class="form-control" placeholder="0.00" step="0.01">
                    </div>
                    <div class="col-6">
                        <label class="text-uppercase">Venta</label>
                        <input type="number" id="in-precio" class="form-control" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <button id="btn-save" class="btn btn-primary w-100 py-2 fw-bold shadow-sm" style="border-radius: 10px;">GUARDAR VENTA</button>
            </div>
        </div>

        <!-- ENTREGAS -->
        <div id="tab-entregas" class="tab-content">
            <div class="card-custom py-2 px-3 mb-2">
                <label class="text-uppercase mb-1">Fecha Reparto</label>
                <input type="date" id="entregas-date" class="form-control" onchange="renderEntregas()">
            </div>
            <div id="lista-entregas"></div>
        </div>

        <!-- CONTROL -->
        <div id="tab-control" class="tab-content">
            <div class="sub-nav">
                <button class="sub-btn active" onclick="window.switchSubTab('sales', this)">Ventas</button>
                <button class="sub-btn" onclick="window.switchSubTab('ticketTienda', this)">Ticket</button>
                <button class="sub-btn" onclick="window.switchSubTab('products', this)">Productos</button>
                <button class="sub-btn" onclick="window.switchSubTab('clients', this)">Clientes</button>
                <button class="sub-btn" onclick="window.switchSubTab('stores', this)">Tiendas</button>
                <button class="sub-btn" onclick="window.switchSubTab('totales', this)">Totales</button>
                <button class="sub-btn" onclick="window.switchSubTab('diezmo', this)">Diezmo</button>
            </div>
            <div id="filter-wrapper" class="p-2"></div>
            <div id="cat-summary" class="px-2"></div>
            <div id="lista-catalogos"></div>
        </div>
    </div>

    <!-- RENDER TICKET -->
    <div id="ticket-render">
        <img src="logo.png" alt="Logo" class="ticket-logo">
        <div class="ticket-header"><h3>OFERTAS RÁPIDAS YAUTE</h3><small id="t-fecha"></small></div>
        <div style="text-align:left; font-size:0.9rem; margin-bottom:12px;"><b>CLIENTE:</b> <span id="t-cliente"></span></div>
        <table class="ticket-table"><tbody id="t-items"></tbody></table>
        <div class="ticket-total"><span>TOTAL:</span><span id="t-total"></span></div>
    </div>

    <nav class="bottom-nav">
        <button class="tab-btn active" onclick="showTab('operaciones', this)"><i class="fas fa-cash-register"></i>Venta</button>
        <button class="tab-btn" onclick="showTab('entregas', this)"><i class="fas fa-truck"></i>Entregas</button>
        <button class="tab-btn" onclick="showTab('control', this)"><i class="fas fa-list-ul"></i>Control</button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeFirestore, collection, doc, addDoc, deleteDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCR5V_yg6aLumW_D8oFPEblHZ5ox2gTs98",
            authDomain: "ofertas-rapidas-yautepec.firebaseapp.com",
            projectId: "ofertas-rapidas-yautepec",
            storageBucket: "ofertas-rapidas-yautepec.firebasestorage.app",
            messagingSenderId: "81339635207",
            appId: "1:81339635207:web:26d180f92224d9a036fca2"
        };

        const appId = "yaute-v1-shared";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });

        let state = { clients: [], products: [], stores: [], sales: [] };
        let activeSubTab = 'sales';

        const getLocalDateString = (date = new Date()) => date.toLocaleDateString('es-MX', { timeZone: 'America/Mexico_City' });
        const getISODateString = (date = new Date()) => new Intl.DateTimeFormat('en-CA', { timeZone: 'America/Mexico_City' }).format(date);

        const showToast = (msg, type = 'success') => {
            const toast = document.getElementById('toast-alert');
            toast.style.background = type === 'success' ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : 'var(--danger)');
            toast.innerText = msg; toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 3000);
        };

        const playSignal = (type) => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type === 'error' ? 'sawtooth' : 'sine';
                osc.frequency.setValueAtTime(type === 'error' ? 180 : 1000, ctx.currentTime);
                gain.gain.setValueAtTime(0.04, ctx.currentTime);
                osc.connect(gain); gain.connect(context.destination);
                osc.start(); osc.stop(ctx.currentTime + 0.2);
            } catch(e) {}
        };

        signInAnonymously(auth);
        onAuthStateChanged(auth, (u) => {
            if (u) {
                document.getElementById('status-dot').className = 'status-indicator bg-success';
                document.getElementById('entregas-date').value = getISODateString();
                startSync();
                setTimeout(() => { 
                    document.getElementById('splash-screen').style.opacity = '0';
                    setTimeout(() => document.getElementById('splash-screen').style.visibility = 'hidden', 800);
                }, 3000);
            }
        });

        const startSync = () => {
            ['clients', 'products', 'stores', 'sales'].forEach(n => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', n), (s) => {
                    state[n] = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderAll();
                });
            });
        };

        // --- LÓGICA DE CÁMARA A COLOR E IA REFORZADA (v10.17) ---
        const apiKey = ""; 
        const btnScan = document.getElementById('btn-scan');
        const camOverlay = document.getElementById('camera-overlay');
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('camera-canvas');
        const btnCapture = document.getElementById('camera-capture');
        let stream = null;

        btnScan.onclick = async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 960 } } 
                });
                video.srcObject = stream;
                camOverlay.style.display = 'flex';
            } catch (e) { showToast("Error de cámara", "danger"); }
        };

        document.getElementById('camera-close').onclick = stopCamera;

        function stopCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            camOverlay.style.display = 'none';
        }

        btnCapture.onclick = () => {
            playSignal('snap');
            processCapture();
        };

        async function processCapture() {
            const ctx = canvas.getContext('2d');
            canvas.width = 1024; 
            canvas.height = 768;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // ENVIAMOS A COLOR NATURAL (Sin filtros que borren texto)
            const base64 = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
            
            stopCamera();
            btnScan.classList.add('processing');
            document.getElementById('scan-text').innerText = "IA LEYENDO ETIQUETA...";

            const result = await callGeminiIA(base64);
            if (result) {
                document.getElementById('in-producto').value = (result.productName || "").toUpperCase().trim();
                if(result.unitCost) document.getElementById('in-costo').value = parseFloat(result.unitCost).toFixed(2);
                
                showToast("Datos extraídos correctamente", "success");
                document.getElementById('in-cantidad').focus();
            } else {
                playSignal('error');
                showToast("No se detectó información. Intente de nuevo.", "warning");
            }
            btnScan.classList.remove('processing');
            document.getElementById('scan-text').innerText = "FOTOGRAFIAR ETIQUETA";
        }

        async function callGeminiIA(base64, retry = 0) {
            const sysPrompt = `Actúa como un experto en extracción de datos de anaqueles.
            La imagen muestra una etiqueta de precio de supermercado.
            REGLAS DE EXTRACCIÓN:
            1. El número con el tamaño de fuente MÁS GRANDE es el PRECIO UNITARIO (unitCost).
            2. El texto ubicado en la esquina SUPERIOR IZQUIERDA es el NOMBRE del producto.
            3. El texto ubicado en la esquina SUPERIOR DERECHA es la PRESENTACIÓN/EMPAQUE (ej. 1L, 500g, 4 pack).
            4. Devuelve un objeto JSON con las claves 'productName' (Nombre + Presentación) y 'unitCost' (Número).
            5. Si no hay precio, devuelve null en unitCost. Responde SOLO el JSON.`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: "Lee esta etiqueta de anaquel." }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }],
                systemInstruction: { parts: [{ text: sysPrompt }] },
                generationConfig: { responseMimeType: "application/json" }
            };
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error();
                const data = await res.json();
                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                // Limpieza básica por si la IA agrega backticks
                const cleanJson = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                return JSON.parse(cleanJson);
            } catch (e) {
                if (retry < 3) { 
                    await new Promise(r => setTimeout(r, 1000)); 
                    return callGeminiIA(base64, retry + 1); 
                }
                return null;
            }
        }

        // --- LÓGICA DE NEGOCIO ORIGINAL ---
        const auto = (id, boxId, key) => {
            const inp = document.getElementById(id); const box = document.getElementById(boxId);
            inp.oninput = () => {
                const val = inp.value.toLowerCase().trim();
                if(!val) { box.classList.add('d-none'); return; }
                const ms = (state[key] || []).filter(x => (x.nombre || '').toLowerCase().includes(val)).slice(0, 5);
                box.innerHTML = ms.map(x => `<div class="sug-item" data-val="${x.nombre}">${x.nombre.toUpperCase()}</div>`).join('');
                box.classList.toggle('d-none', ms.length === 0);
            };
            box.onclick = (e) => {
                const item = e.target.closest('.sug-item'); if(!item) return;
                inp.value = item.dataset.val.toUpperCase(); box.classList.add('d-none');
                if(key === 'products') {
                    const p = state.products.find(x => (x.nombre||"").toLowerCase() === item.dataset.val.toLowerCase());
                    if(p) { document.getElementById('in-costo').value = p.pCosto || ""; document.getElementById('in-precio').value = p.pVenta || ""; }
                }
            };
        };
        auto('in-tienda', 'sug-tienda', 'stores'); auto('in-cliente', 'sug-cliente', 'clients'); auto('in-producto', 'sug-producto', 'products');

        window.showTab = (id, btn) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active'); renderAll(); 
        };

        window.switchSubTab = (id, btn) => {
            activeSubTab = id; if (btn) { document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            const w = document.getElementById('filter-wrapper');
            if (id === 'diezmo') w.innerHTML = `<div class="row g-2"><div class="col-6"><input type="date" id="diezmo-start" class="filter-input" value="${getISODateString()}"></div><div class="col-6"><input type="date" id="diezmo-end" class="filter-input" value="${getISODateString()}"></div><button class="btn btn-sm btn-primary mt-1" onclick="window.renderCatalogList()">CALCULAR</button></div>`;
            else if (['sales', 'totales', 'ticketTienda'].includes(id)) {
                const st = [...new Set(state.stores.map(s => s.nombre.toUpperCase()))].sort().map(s => `<option value="${s}">${s}</option>`).join('');
                w.innerHTML = `<div class="row g-2"><div class="col-6"><select id="filter-store" class="filter-input" onchange="window.renderCatalogList()"><option value="">-- TODAS --</option>${st}</select></div><div class="col-6"><input type="date" id="cat-date" class="filter-input" value="${getISODateString()}" onchange="window.renderCatalogList()"></div></div>`;
            } else w.innerHTML = `<input type="text" id="search-generic" class="filter-input" placeholder="Buscar..." oninput="window.renderCatalogList()">`;
            renderCatalogList();
        };

        const renderAll = () => { renderEntregas(); renderCatalogList(); };

        window.renderEntregas = () => {
            const dv = document.getElementById('entregas-date')?.value || getISODateString();
            const targetDate = getLocalDateString(new Date(dv + "T12:00:00"));
            const list = document.getElementById('lista-entregas');
            const vH = state.sales.filter(s => s.fechaStr === targetDate);
            if (!vH.length) { list.innerHTML = '<p class="text-center py-4 text-muted small">Sin ventas hoy</p>'; return; }
            const g = vH.reduce((acc, v) => { const c = v.cliente || "S/N"; if(!acc[c]) acc[c] = {total: 0, items: []}; acc[c].total += (v.total || 0); acc[c].items.push(v); return acc; }, {});
            list.innerHTML = Object.keys(g).map(cli => {
                const items = g[cli].items; const tEnt = items.every(i => i.entregado); const tPag = items.every(i => i.pagado);
                return `<div class="card-custom ${tEnt && tPag ? 'card-entrega-completo' : tPag ? 'card-entrega-pagado' : tEnt ? 'card-entrega-enviado' : ''}">
                    <div class="d-flex justify-content-between mb-2">
                        <div><span class="fw-bold small text-uppercase">${cli}</span></div>
                        <button class="btn btn-sm btn-success rounded-pill" onclick="window.genTicket('${cli}')">TICKET</button>
                    </div>
                    <div class="small">${items.map(i => `<div>${i.cantidad}x ${i.producto}</div>`).join('')}</div>
                    <div class="text-end fw-bold pt-1 border-top mt-1">$${g[cli].total.toFixed(2)}</div>
                </div>`;
            }).join('');
        };

        window.renderCatalogList = () => {
            const l = document.getElementById('lista-catalogos');
            if(!l) return;
            const fD = getLocalDateString(new Date((document.getElementById('cat-date')?.value || getISODateString()) + "T12:00:00"));
            const storeF = document.getElementById('filter-store')?.value.toUpperCase() || "";
            if (activeSubTab === 'sales') {
                let dv = state.sales.filter(v => v.fechaStr === fD); if (storeF) dv = dv.filter(v => (v.tienda || "").toUpperCase() === storeF);
                l.innerHTML = dv.map(v => `<div class="card-custom d-flex justify-content-between align-items-center py-2 mb-1 small"><div><b>${v.cantidad}x ${v.producto}</b><br><span class="text-muted">${v.tienda} • ${v.cliente}</span></div><div class="fw-bold">$${v.total.toFixed(2)}</div><button class="btn text-danger btn-sm" onclick="window.del('sales', '${v.id}')"><i class="fas fa-trash"></i></button></div>`).join('');
            } else if (activeSubTab === 'diezmo') {
                const sd = new Date((document.getElementById('diezmo-start')?.value || getISODateString()) + "T00:00:00");
                const ed = new Date((document.getElementById('diezmo-end')?.value || getISODateString()) + "T23:59:59");
                const fs = state.sales.filter(v => { const d = v.fecha ? v.fecha.toDate() : new Date(); return d >= sd && d <= ed; });
                let tC = 0, tV = 0; fs.forEach(v => { tC += ((v.costo||0)*v.cantidad); tV += v.total; });
                l.innerHTML = `<div class="card-custom bg-primary text-white text-center py-4"><h3>$${((tV-tC)*0.1).toFixed(2)}</h3><div class="small">Diezmo Acumulado (10%)</div></div>`;
            } else if (['products', 'clients', 'stores'].includes(activeSubTab)) {
                const search = document.getElementById('search-generic')?.value.toLowerCase() || "";
                let data = [...state[activeSubTab]].filter(i => (i.nombre || "").toLowerCase().includes(search)).sort((a,b) => (a.nombre||"").localeCompare(b.nombre||""));
                l.innerHTML = data.map(i => `<div class="card-custom d-flex justify-content-between align-items-center py-2 mb-1 small"><b>${i.nombre}</b><button class="btn text-danger btn-sm" onclick="window.del('${activeSubTab}', '${i.id}')"><i class="fas fa-trash"></i></button></div>`).join('');
            }
        };

        window.del = async (col, id) => { if (confirm("¿Eliminar?")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id)); showToast("Eliminado"); } };

        document.getElementById('btn-save').onclick = async () => {
            const data = { tienda: document.getElementById('in-tienda').value.trim().toUpperCase(), cliente: document.getElementById('in-cliente').value.trim().toUpperCase(), producto: document.getElementById('in-producto').value.trim().toUpperCase(), cantidad: parseInt(document.getElementById('in-cantidad').value) || 1, costo: parseFloat(document.getElementById('in-costo').value) || 0, precio: parseFloat(document.getElementById('in-precio').value) || 0 };
            if (!data.tienda || !data.cliente || !data.producto || data.costo <= 0 || data.precio <= 0) return showToast("Faltan datos", 'danger');
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), { ...data, total: data.cantidad * data.precio, fecha: serverTimestamp(), fechaStr: getLocalDateString(), entregado: false, pagado: false });
                const ck = async (c, v) => { if(!state[c].some(i => i.nombre.toUpperCase() === v.toUpperCase())) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', c), { nombre: v }); };
                await ck('clients', data.cliente); await ck('stores', data.tienda);
                const exP = state.products.find(p => p.nombre.toUpperCase() === data.producto.toUpperCase());
                if(!exP) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), { nombre: data.producto, pCosto: data.costo, pVenta: data.precio });
                else await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', exP.id), { pCosto: data.costo, pVenta: data.precio });
                document.getElementById('in-cliente').value = ""; document.getElementById('in-producto').value = ""; document.getElementById('in-costo').value = ""; document.getElementById('in-precio').value = "";
                showToast("Guardado");
            } catch(e) { showToast("Error al guardar", 'danger'); }
        };

        window.genTicket = async (cli) => {
            const dv = document.getElementById('entregas-date')?.value || getISODateString();
            const targetDate = getLocalDateString(new Date(dv + "T12:00:00"));
            const items = state.sales.filter(s => s.cliente.toUpperCase() === cli.toUpperCase() && s.fechaStr === targetDate);
            document.getElementById('t-fecha').innerText = targetDate; document.getElementById('t-cliente').innerText = cli.toUpperCase();
            let t = 0; document.getElementById('t-items').innerHTML = items.map(i => { t += i.total; return `<tr><td>${i.cantidad}x ${i.producto}</td><td style="text-align:right;">$${i.total.toFixed(2)}</td></tr>`; }).join('');
            document.getElementById('t-total').innerText = `$${t.toFixed(2)}`;
            const canvasT = await html2canvas(document.getElementById('ticket-render'), { scale: 3 });
            canvasT.toBlob(blob => {
                const file = new File([blob], `Ticket_${cli}.png`, { type: 'image/png' });
                if (navigator.share) navigator.share({ files: [file], title: 'Ticket' });
            });
        };
    </script>
</body>
</html>